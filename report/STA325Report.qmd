---
title: "Life Expectancy"
author: "Dillan Sant, Chase Mathis"
format:
  pdf:
    documentclass: article
    geometry: 
      - margin=1in
editor: visual
execute: 
  echo: false
  message: false
  warning: false
---

## Introduction

Humans have experienced a meteoric rise in life expectancy in the past 200 years thanks to major advances in public health, but recently the momentum has stalled if not reversed.[^1] From a young age, we are taught to have a healthy diet, exercise regularly, and keep up personal hygiene to stay healthy and therefore live longer. However, macro-factors clearly play a role in how healthy ones life is. Health policy and its relationship with these macro-factors greatly impacts the health of individuals as this most recent pandemic has shown.

[^1]: https://www.health.harvard.edu/blog/why-life-expectancy-in-the-us-is-falling-202210202835#:\~:text=A%20dramatic%20fall%20in%20life,just%20over%2076%2C%20in%202021.

This research project aims to investigate the relationship between macro-factors and life expectancy for a developing and developed countries alike. Our research questions are the following:

\(1\) *Given a country is developing, what can they do to increase their Life Expectancy?* This question hopes to guide methods for public policy and health experts in developing countries. Generally, developing countries have a lower life expectancy, so what does the data say about what is the most important?

\(2\) *For countries that already have a high life expectancy, is it economically beneficial to attempt to marginally increase life expectancy?* Developed countries have had the advantage of modern medicine for quite some time, so this question investigates if incremental increases in life expectancy are "worth" the increase in global health expenditure. Should countries focus on research in finding a "miracle" vaccine, or is there still work to be done for cheaper issues like vaccination and schooling.

\_\_\_\_ collected the data. The data has 21 features, which we will outline below. Each observation in our data is a a country, the year. As the features are summary statistics, we are predicting averages from averages. We will *not* use black-box models such as random forrests or baggging to get high predictive accuracy, as this question investigates aggregate relationships. We will therefore be using statistical modeling techniques such as linear regression, regularized regression, trees, and GAMS, we aim to quantify the magnitude and type of relationships between life expectancy and each of our features.

```{r}
#| label: packages
#| echo: false
#| message: false


library(tidyverse)
library(tidymodels)
library(knitr)
library(patchwork)
library(broom)
library(MASS)
library(fuzzyjoin)
#install.packages("fuzzyjoin")

life <- read_csv("data/life_exp.csv")
ggplot2::theme_set(ggplot2::theme_bw())
worldData <- map_data("world")
```

## Data

\*\* Dillan can you do as you found the data\*\*

```{r}
## fixing for graph plots
worldData <- worldData |> 
  mutate(region = case_when(
    region == "Antigua" ~ "Antigua and Barbuda",
    region == "Bolivia" ~ "Bolivia (Plurinational State of)",
    region == "Brunei" ~ "Brunei Darussalam",
    region == "Ivory Coast" ~ "CÃ´te d'Ivoire",
    region == "Cape Verde" ~ "Cabo Verde",
    region == "Democratic Republic of the Congo" ~ "Congo",
    region == "Czech Republic" ~ "Czechia",
    region == "North Korea" ~ "Democratic People's Republic of Korea",
    region == "Iran" ~ "Iran (Islamic Republic of)",
    region == "Laos" ~ "Lao People's Democratic Republic",
    region == "Micronesia" ~ "Micronesia (Federated States of)",
    region == "South Korea" ~ "Republic of Korea",
    region == "Moldova" ~ "Republic of Moldova",
    region == "Russia" ~ "Russian Federation",
    region == "Syria" ~ "Syrian Arab Republic",
    region == "Trinidad" ~ "Trinidad and Tobago",
    region == "UK" ~ "United Kingdom of Great Britain and Northern Ireland",
    region == "Tanzania" ~ "United Republic of Tanzania",
    region == "USA" ~ "United States of America",
    region == "Venezuela" ~ "Venezuela (Bolivarian Republic of)",
    region == "Vietnam" ~ "Viet Nam",
    region == "Saint Kitts" ~ "Saint Kitts and Nevis",                
    region != "" ~ region
  ))
```

```{r}
life <- life %>% mutate(Status = factor(Status, levels = c("Developing", "Developed"))) %>%
  rename(life_exp = "Life expectancy", adult_mortality = "Adult Mortality", 
        infant_mortality = "infant deaths", pct_expend = "percentage expenditure", 
        hep_b = "Hepatitis B", under_five_deaths = "under-five deaths", 
        tot_expend = "Total expenditure", hiv_aids = "HIV/AIDS",
        thinness_adole = "thinness  1-19 years", thinness_infant = "thinness 5-9 years", 
        income_comp = "Income composition of resources") 
```

## Data Cleaning and Limitations in Our Data

```{r}
life |>  
  summarise(across(everything(), ~ sum(is.na(.)))) |> 
  pivot_longer(everything()) |> 
  arrange(desc(value)) |> 
  mutate(percent_missing = value/nrow(life)) |> 
  slice(1:5)
```

The data is mostly complete, but certain countries are missing data on population, GDP, and Hepatitis B. In other instances where one or two years are missing a specific countries data, we can fill in that value with the mean of the specific category.

```{r}
#| label: pre-processing
set.seed(123)
split <- initial_split(life)
training_life <- training(split)
testing_life <- testing(split)

```

```{r}
life |> 
  filter(Year == 2015) |> 
  dplyr::select(Country,life_exp) |> 
  arrange(desc(life_exp)) |> 
  slice(1:10) |> 
  kable(col.names = c("Country", "Life Expectancy"), caption = "Life Expectancy of the Top 10 Countries")
```

```{r}
control_vars <- c("Alcohol","pct_expend", "hep_b", "Polio", "tot_expend", "Diphtheria", "Schooling")
uncontrol_vars <- c("BMI", "GDP", "Population", "thinnes_adole", "thinness_infant", "income_comp", "Status")
indicator_vars <- c("under_five_deaths", "life_exp", "adult_mortality", "infant_mortality")
```

## Exploratory Data Analysis

```{r}
life %>% 
  filter(Year == 2015) %>% 
  ggplot(aes(x = GDP, y = life_exp, color = Status)) + 
  geom_point()
```

```{r}
deltaLifeExp <- life |> 
  filter(Year == 2000 | Year == 2015) |> 
  group_by(Country) |> 
  mutate(delta_Life_Exp = lag(life_exp) - life_exp) |> 
  relocate(delta_Life_Exp) |> 
  ungroup() |> 
  drop_na(delta_Life_Exp) 

p1 <- deltaLifeExp |> 
  ggplot(aes(x = delta_Life_Exp)) + 
  geom_histogram(bins = 10) + 
  labs(
    x = "Change in Life Expectancy",
    y = "Frequency",
    title = "Distribution of the Change in Life Expectancy for Different Countries"
  )

p2 <- life |> 
  ggplot(aes(x = Year, y = life_exp, group = Year)) + 
  geom_boxplot() + 
  labs(
    x = "Year",
    y = "Life expectancy",
    title = "Change in Life Expectancies Across the Globe"
  )

p3 <- worldData |> 
full_join(deltaLifeExp, by = c("region" = "Country")) |> 
ggplot(aes(x = long, y = lat, group = group, fill = delta_Life_Exp)) +
  geom_polygon() + 
  scale_fill_continuous(type = "viridis")

```

```{r}
(p1 + p2)/p3
```

Generally countries increased life expectancy, especially in Sub-Saharan Africa. Which countries experienced a decrease in life expectancy.

```{r}
deltaLifeExp %>% filter(delta_Life_Exp < 0) %>% 
  dplyr::select(delta_Life_Exp, Country) %>% arrange(delta_Life_Exp) %>%
  rename("Change in Life Expectancy" = delta_Life_Exp) %>% kable()
```

From 2000-2015, the nations that experienced a decrease in life expectancy are Syria, St. Vincent and the Grenandines, Libya, Paraguay, Yemen, Romania, Iraq, Estonia, and Grenada. All of these nations except for Romania are developing.

```{r}
negativeLife <- deltaLifeExp |> 
  filter(delta_Life_Exp < 0)
```

## Research Question 1: Given a country is developing, what can they do to increase their Life Expectancy?

```{r}
#| label: data-pre-processing

life_control_developing <- recipe( ~ ., data = training_life) |> 
  update_role(Country, new_role = "ID") |> 
  step_filter(Status == "Developing") |>   # only developing countries
  step_select(all_of(control_vars), Country, life_exp, skip = TRUE) |>    #only uses control variables
    update_role(life_exp, new_role = "outcome")


life_uncontrol_developing <- recipe(life_exp ~ ., data = training_life) |> 
  update_role(Country, new_role = "ID") |> 
  step_filter(Status == "Developing") |>   # only developing countries
  step_select(all_of(uncontrol_vars), Country) |> #only uses control variables
  step_dummy(all_nominal_predictors())
```

```{r}
#| label: models

linear_spec <- linear_reg() |> 
  set_engine("lm")

lasso_spec <- linear_reg(penalty = 0.01, mixture = 1) |> 
  set_engine("glmnet")
```

```{r}

wflow_control_developed <- workflow() %>%
  add_model(linear_spec) %>%
  add_recipe(life_control_developing) 


control_developed_fit <- wflow_control_developed |> 
  fit(data = training_life)

lmTable1 <- tidy(control_developed_fit) |>
  mutate(significant = if_else(p.value < 0.05, "Significant", "Not Significant")) |> 
  dplyr::select(term, estimate, p.value, significant) |> 
  arrange(desc(abs(estimate))) |> 
  kable(col.names = c("Term", "Estimate", "P-Value", "Significant?"))

lmTable1
```

### Linear Regression

We first fit a linear regression model predicting life expectancy from our control variables we outline in our data dictionary. As one can see from the output, hepatitis B vaccination rate and total expenditure are not statistically significant predictors, while the rest are.

At first glance, I notice a few interesting insights. For one, increasing Schooling by one year seems to have the largest real effect on life expectancy. Schooling, which very few public health experts discuss seems to have the largest impact! Second, this regression model shows that HIV/AIDS vaccination rates are inversely related to life expectancy. One conclusion of this finding is that in countries where HIV/AIDS is not a problem, citizens are not vaccinated for it. In countries where it is a problem, more people are vaccinated for it, and more people die from it. **This is a short come of our limited data and should be noted. Alcohol** is naturally inversely related with life expectancy, while alcohol and a countries GDP may be related to one another.

### Find a Sparse Model 

```{r}
#wflow_control_developed_lasso <- workflow() %>%
#  add_model(lasso_spec) %>%
#  add_recipe(life_control_developing) 
#
#
#control_developed_fit_lasso <- wflow_control_developed_lasso |> 
#  fit(data = training_life)
#
#lmTable1 <- tidy(control_developed_fit_lasso) |>
#  mutate(significant = if_else(p.value < 0.05, "Significant", "Not Significant")) |> 
#  dplyr::select(term, estimate, p.value, significant) |> 
#  arrange(desc(abs(estimate))) |> 
#  kable(col.names = c("Term", "Estimate", "P-Value", "Significant?"))
#
#lmTable1
```

### Include in first research question: For the small subset of countries that saw a decrease in life expectancy from 2000-2015, what factors led to this decrease in life expectancy?

```{r}
delta_cont <- life |> 
  filter(Year == 2000 | Year == 2015) |> 
  group_by(Country) |> 
  mutate(delta_Life_Exp = lag(life_exp) - life_exp, delta_alc = lag(Alcohol) - Alcohol, delta_pe = lag(pct_expend) - pct_expend, delta_hep = lag(hep_b) - hep_b, delta_pol = lag(Polio) - Polio, delta_expend = lag(tot_expend) - tot_expend, delta_dip = lag(Diphtheria) - Diphtheria, delta_hiv = lag(hiv_aids) - hiv_aids, delta_school = lag(Schooling) - Schooling) |>
  ungroup()
```

## Research Question 2: For countries that already have a high life expectancy, is it economically beneficial to attempt to marginally increase life expectancy?

## Notes

### Introduction/EDA

-   start with providing scientific context, refer to article
-   shift towards problem, introduce research questions
-   give detailed description of data (see rubric), which predictors are uncontrollable, controllable, indicators
-   start EDA, show some simple, interpretable plots regarding different predictors, find different relationships among controllable variables

### Modeling

-   Start with linear regression
-   check out interaction effects
-   ridge, lasso (for interpretable variable selection)
-   trees
-   stay away from uninterpretable methods like random forests, boosting

### Within Research Questions

-   focus on answering research question, using data/modeling merely as support for argument
-   make sure models and its results would be interpretable for global health professionals and governments
-   plot model diagnostics to assess models, make tables of results/predictions of models
-   give suggestions based on results to policy makers (ex. "this nation should put a greater prorportion of their total expenditure into health care to increase life expectancy")

### Conclusion

-   suggest in which factors specific nations should invest their money in based on modeling during both research questions, or, suggest not to increase investment in health care for nations with already high life expectancy
-   reference models, focus on interpretability and policy actions

## Appendix

### Data Dictionary

### Controllable Variables

-   `Alcohol`: Alcohol consumption per capita (liters of pure alcohol)
-   `pct_expend`: Expenditure on health as a percentage of GDP per capita
-   `hep_b`: Hepatitis B immunization rate among 1-year-olds (%)
-   `Polio`: Polio immunization rate among 1-year-olds (%)
-   `tot_expend`: Government expenditure on healthcare as a percentage of total government expenditure
-   `Diphtheria`: Diphtheria tetnus toxoid and pertussis immunization rate among 1-year-olds (%)
-   `Schooling`: Average number of years of schooling

### Uncontrollable Variables (Nuiscance Variables)

-   `BMI`: Average BMI (Body Mass Index) of entire country's population
-   `GDP`: GDP per capita
-   `Population`: Total population of country
-   `thinnes_adole`: Prevalence of "thinness" among adolescents aged 10-19 (%)
-   `thinness_infant`: Prevalence of "thinness" among infants aged 5-9 (%)
-   `income_comp`: Human Development Index in terms of income composition of resources (0 to 1)
-   `Status`: Developmental status of country (Developed or Developing)

### Indicator Variables

-   `under_five_deaths`: Number of deaths of 5-year-olds or younger per 1000 people
-   `life_exp`: Average expectancy in country (years)
-   `adult_mortality`: Number of deaths of people aged 15-60 per 1000 people
-   `infant_mortality`: Number of infants deaths per 1000 infants
-   `hiv_aids`: Number of deaths of 0-4 year-olds from HIV/AIDS per 1000 live births
