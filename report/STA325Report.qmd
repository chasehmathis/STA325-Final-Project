---
title: "Life Expectancy"
author: "Dillan Sant, Chase Mathis"
format:
  pdf:
    documentclass: article
    geometry: 
      - margin=1in
editor: visual
execute: 
  echo: false
  message: false
  warning: false
---

## Introduction

Humans have experienced a meteoric rise in life expectancy in the past 200 years thanks to major advances in public health, but recently the momentum has stalled if not reversed.[^1] From a young age, we are taught to have a healthy diet, exercise regularly, and keep up personal hygiene to stay healthy and therefore live longer. However, macro-factors clearly play a role in how healthy ones life is. Health policy and its relationship with these macro-factors greatly impacts the health of individuals as this most recent pandemic has shown.

[^1]: https://www.health.harvard.edu/blog/why-life-expectancy-in-the-us-is-falling-202210202835#:\~:text=A%20dramatic%20fall%20in%20life,just%20over%2076%2C%20in%202021.

This research project aims to investigate the relationship between macro-factors and life expectancy for a developing and developed countries alike. Experts in public policy and public health are our intended audience as we attempt to give them further evidence on what should be prioritized in the the struggle to keep their citizens healthy. Our research questions are the following:

\(1\) *Given a country is developing, what can they do to increase their Life Expectancy?* This question hopes to guide methods for public policy and health experts in developing countries. Generally, developing countries have a lower life expectancy, so what does the data say about what is the most important?

\(2\) *For countries that already have a high life expectancy, is it economically beneficial to attempt to marginally increase life expectancy?* Developed countries have had the advantage of modern medicine for quite some time, so this question investigates if incremental increases in life expectancy are "worth" the increase in global health expenditure. Should countries focus on research in finding a "miracle" vaccine, or is there still work to be done for cheaper issues like vaccination and schooling.

Similar to how each person gets individual treatment from their primary care physician on their health, we think it is important to divide the research into the categories outlined above so the findings can be more specific and beneficial for nations who fall into those categories. We've also split up our predictors in a likewise fashion. We categorized "Control" variables as features that public policy and health experts can somewhat control. We then categorized "Nuisance" variables as those which governments have little control over such as Population, BMI, and GDP.

Our first research question hopes to tackle the issue of inequality in life expectancy based off where one was born. Developing countries must increase their life expectancy so to match that of other developed countries. The economic benefit of a healthy, long-living country is clear and thus important to understand how to cultivate. The second one hopes to answer an important question of the utility of investing in public health measures. In other words, is there some law of nature that limits how old one can get? How beneficial is it to increase health expenditure? Instead, should governments invest in cutting-edge research to find miracle cures?

\_\_\_\_ collected the data. The data has 21 features, which we will outline below. Each observation in our data is a a country, the year. As the features are summary statistics, we are predicting averages from averages. We will *not* use black-box models such as random forests or bagging to get high predictive accuracy, as this question investigates aggregate relationships. We will therefore be using statistical modeling techniques such as linear regression, regularized regression, trees, and GAMS, we aim to quantify the magnitude and type of relationships between life expectancy and each of our features.

```{r}
#| label: packages
#| echo: false
#| message: false


library(tidyverse)
library(tidymodels)
library(knitr)
library(patchwork)
library(broom)
library(MASS)
library(fuzzyjoin)
library(rpart.plot)
#install.packages("rpart.plot")
#install.packages("fuzzyjoin")

life <- read_csv("data/life_exp.csv")
ggplot2::theme_set(ggplot2::theme_bw())
worldData <- map_data("world")
```

## Data

\*\* Dillan can you do as you found the data\*\*

```{r}
## fixing for graph plots
worldData <- worldData |> 
  mutate(region = case_when(
    region == "Antigua" ~ "Antigua and Barbuda",
    region == "Bolivia" ~ "Bolivia (Plurinational State of)",
    region == "Brunei" ~ "Brunei Darussalam",
    region == "Ivory Coast" ~ "CÃ´te d'Ivoire",
    region == "Cape Verde" ~ "Cabo Verde",
    region == "Democratic Republic of the Congo" ~ "Congo",
    region == "Czech Republic" ~ "Czechia",
    region == "North Korea" ~ "Democratic People's Republic of Korea",
    region == "Iran" ~ "Iran (Islamic Republic of)",
    region == "Laos" ~ "Lao People's Democratic Republic",
    region == "Micronesia" ~ "Micronesia (Federated States of)",
    region == "South Korea" ~ "Republic of Korea",
    region == "Moldova" ~ "Republic of Moldova",
    region == "Russia" ~ "Russian Federation",
    region == "Syria" ~ "Syrian Arab Republic",
    region == "Trinidad" ~ "Trinidad and Tobago",
    region == "UK" ~ "United Kingdom of Great Britain and Northern Ireland",
    region == "Tanzania" ~ "United Republic of Tanzania",
    region == "USA" ~ "United States of America",
    region == "Venezuela" ~ "Venezuela (Bolivarian Republic of)",
    region == "Vietnam" ~ "Viet Nam",
    region == "Saint Kitts" ~ "Saint Kitts and Nevis",                
    region != "" ~ region
  ))
```

```{r}
life <- life %>% mutate(Status = factor(Status, levels = c("Developing", "Developed"))) %>%
  rename(life_exp = "Life expectancy", adult_mortality = "Adult Mortality", 
        infant_mortality = "infant deaths", pct_expend = "percentage expenditure", 
        hep_b = "Hepatitis B", under_five_deaths = "under-five deaths", 
        tot_expend = "Total expenditure", hiv_aids = "HIV/AIDS",
        thinness_adole = "thinness  1-19 years", thinness_infant = "thinness 5-9 years", 
        income_comp = "Income composition of resources") 
```

## Data Cleaning and Limitations in Our Data

```{r}
life |>  
  summarise(across(everything(), ~ sum(is.na(.)))) |> 
  pivot_longer(everything()) |> 
  arrange(desc(value)) |> 
  mutate(percent_missing = value/nrow(life)) |> 
  slice(1:5)
```

The data is mostly complete, but certain features are missing values. The missing data will have an impact on our modeling and interpretation which is something to consider for future work. For the time being, we will split up our missing values into two categories: (1) Missing values for entire countries and (2) Missing values for time ranges within a certain country. In regards to the first type of na value, we are left with little options. Many types of models will throw errors if there is missing data, so when fitting models that depend on predictors with missing data, we will throw away observations where missing data is present. In the other case, we propose using the mean of the other samples in that country to fill in the data. For instance, if Algeria has data on its alcohol consumption for all years except 2006, we assume that we should estimate 2006 using the mean. We continue with this methodology.

```{r}
percent_na <- 1-(nrow(na.omit(life))/nrow(life))
life <- life |> 
  group_by(Country) |> 
  mutate(Alcohol = replace_na(Alcohol, mean(Alcohol, na.rm = TRUE)),
         Population = replace_na(Population, mean(Population, na.rm = TRUE)),
         hep_b = replace_na(hep_b, mean(hep_b, na.rm = TRUE)),
         GDP = replace_na(GDP, mean(GDP, na.rm = TRUE)),
        tot_expend = replace_na(tot_expend, mean(tot_expend, na.rm = TRUE)),
        income_comp = replace_na(income_comp, mean(income_comp, na.rm = TRUE)),
        Schooling = replace_na(Schooling, mean(Schooling, na.rm = TRUE))) |> 
  ungroup()

percent_na_after <- 1-(nrow(na.omit(life))/nrow(life))
```

After filling in na values with the mean, we are able to decrease the percent of na-values from `r 100*round(percent_na,3)`% to `r 100*round(percent_na_after,3)`%. This reduction will help us use more of the data so that we can find better conclusions for policy makers. We did not check to see the distributions of before omitting the na values match the distributions after\*\*\*.

## Exploratory Data Analysis

```{r}
#| label: pre-processing

life <- na.omit(life)
set.seed(123)
split <- initial_split(life)
training_life <- training(split)
testing_life <- testing(split)

```

```{r}
life |> 
  filter(Year == 2015) |> 
  dplyr::select(Country,life_exp) |> 
  arrange(desc(life_exp)) |> 
  slice(1:10) |> 
  kable(col.names = c("Country", "Life Expectancy"), caption = "Life Expectancy of the Top 10 Countries")
```

```{r}
control_vars <- c("Alcohol","pct_expend", "hep_b", "Polio", "tot_expend", "Diphtheria", "Schooling")
uncontrol_vars <- c("BMI", "GDP", "Population", "thinnes_adole", "thinness_infant", "income_comp", "Status")
indicator_vars <- c("under_five_deaths", "life_exp", "adult_mortality", "infant_mortality")
```

```{r}
life %>% 
  filter(Year == 2015) %>% 
  ggplot(aes(x = GDP, y = life_exp, color = Status)) + 
  geom_point()
```

```{r}
deltaLifeExp <- life |> 
  filter(Year == 2000 | Year == 2015) |> 
  group_by(Country) |> 
  mutate(delta_Life_Exp = lag(life_exp) - life_exp) |> 
  relocate(delta_Life_Exp) |> 
  ungroup() |> 
  drop_na(delta_Life_Exp) 

p1 <- deltaLifeExp |> 
  ggplot(aes(x = delta_Life_Exp)) + 
  geom_histogram(bins = 10) + 
  labs(
    x = "Change in Life Expectancy",
    y = "Frequency",
    title = "Distribution of the Change in Life Expectancy for Different Countries"
  )

p2 <- life |> 
  ggplot(aes(x = Year, y = life_exp, group = Year)) + 
  geom_boxplot() + 
  labs(
    x = "Year",
    y = "Life expectancy",
    title = "Change in Life Expectancies Across the Globe"
  )

p3 <- worldData |> 
full_join(deltaLifeExp, by = c("region" = "Country")) |> 
ggplot(aes(x = long, y = lat, group = group, fill = delta_Life_Exp)) +
  geom_polygon() + 
  scale_fill_continuous(type = "viridis")

```

```{r}
(p1 + p2)/p3
```

Generally countries increased life expectancy, especially in Sub-Saharan Africa. Which countries experienced a decrease in life expectancy.

```{r}
deltaLifeExp %>% filter(delta_Life_Exp < 0) %>% 
  dplyr::select(delta_Life_Exp, Country) %>% arrange(delta_Life_Exp) %>%
  rename("Change in Life Expectancy" = delta_Life_Exp) %>% kable()
```

From 2000-2015, the nations that experienced a decrease in life expectancy are Syria, St. Vincent and the Grenandines, Libya, Paraguay, Yemen, Romania, Iraq, Estonia, and Grenada. All of these nations except for Romania are developing.

```{r}
negativeLife <- deltaLifeExp |> 
  filter(delta_Life_Exp < 0)
```

## Research Question 1: Given a country is developing, what can they do to increase their Life Expectancy?

```{r}
#| label: models

linear_spec <- linear_reg() |> 
  set_engine("lm")

lasso_spec <- linear_reg(penalty = 0.01, mixture = 1) |> 
  set_engine("glmnet")


tree_spec <- decision_tree(mode = "regression") |> 
  set_engine("rpart")
```

### Linear Regression

We first fit a linear regression model predicting life expectancy from our control variables we outline in our data dictionary. As one can see from the output, hepatitis B vaccination rate and total expenditure are not statistically significant predictors, while the rest are.

At first glance, I notice a few interesting insights. For one, increasing Schooling by one year seems to have the largest real effect on life expectancy. Schooling, which very few public health experts discuss seems to have the largest impact! Second, this regression model shows that HIV/AIDS vaccination rates are inversely related to life expectancy. One conclusion of this finding is that in countries where HIV/AIDS is not a problem, citizens are not vaccinated for it. In countries where it is a problem, more people are vaccinated for it, and more people die from it. **This is a short come of our limited data and should be noted. Alcohol** is naturally inversely related with life expectancy, while alcohol and a countries GDP may be related to one another.

```{r}
#| label: data-pre-processing

life_control_developing <- recipe( ~ ., data = training_life) |> 
  update_role(Country, new_role = "ID") |> 
  step_filter(Status == "Developing") |>   # only developing countries
  step_select(all_of(control_vars), Country, life_exp, skip = TRUE) |>    #only uses control variables
    update_role(life_exp, new_role = "outcome")


life_uncontrol_developing <- recipe(life_exp ~ ., data = training_life) |> 
  update_role(Country, new_role = "ID") |> 
  step_filter(Status == "Developing") |>   # only developing countries
  step_select(all_of(uncontrol_vars), Country) |> #only uses control variables
  step_dummy(all_nominal_predictors())
```

```{r}

wflow_control_developed <- workflow() %>%
  add_model(linear_spec) %>%
  add_recipe(life_control_developing) 


control_developed_fit <- wflow_control_developed |> 
  fit(data = training_life)

lmTable1 <- tidy(control_developed_fit) |>
  mutate(significant = if_else(p.value < 0.05, "Significant", "Not Significant")) |> 
  dplyr::select(term, estimate, p.value, significant) |> 
  arrange(desc(abs(estimate))) |> 
  kable(col.names = c("Term", "Estimate", "P-Value", "Significant?"))

lmTable1
```

### Find a Sparse Model

```{r}
wflow_control_developed_lasso <- workflow() %>%
 add_model(lasso_spec) %>%
 add_recipe(life_control_developing) 


control_developed_fit_lasso <- wflow_control_developed_lasso |> 
 fit(data = training_life)

lmTable1 <- tidy(control_developed_fit_lasso) |> 
 filter(estimate > 0.01) |> 
 dplyr::select(term, estimate,penalty) |> 
 arrange(desc(abs(estimate))) |> 
 kable(col.names = c("Term", "Estimate", "Penalty"))

lmTable1
```

### Interaction Effects Through Trees?

The tree model illustrates the importance of schooling in increasing a country's life expectancy. The first decision the tree makes is off of schooling. In addition, schooling is the most prevalent decision the tree makes. Following the left sub-tree, interactions between schooling and other variables emerge. This is interesting given that the right sub-tree has much less interactions, and instead attempts to predict based off more School decisions.

```{r}
wflow_controlled_tree <- workflow() %>%
 add_model(tree_spec) %>%
 add_recipe(life_control_developing) 

control_developed_fit_tree <- wflow_controlled_tree |> 
 fit(data = training_life)

control_developed_fit_tree <- control_developed_fit_tree$fit$fit$fit

rpart.plot(control_developed_fit_tree,roundint = FALSE)
```

### Include in first research question: For the small subset of countries that saw a decrease in life expectancy from 2000-2015, what factors led to this decrease in life expectancy?

```{r}
delta_cont <- life |> 
  filter(Year == 2000 | Year == 2015) |> 
  group_by(Country) |> 
  mutate(delta_Life_Exp = lag(life_exp) - life_exp, delta_alc = lag(Alcohol) - Alcohol, delta_pe = lag(pct_expend) - pct_expend, delta_hep = lag(hep_b) - hep_b, delta_pol = lag(Polio) - Polio, delta_expend = lag(tot_expend) - tot_expend, delta_dip = lag(Diphtheria) - Diphtheria, delta_hiv = lag(hiv_aids) - hiv_aids, delta_school = lag(Schooling) - Schooling) |>
  ungroup()
```

## Research Question 2: For countries that already have a high life expectancy, is it economically beneficial to attempt to marginally increase life expectancy?

## Notes

### Introduction/EDA

-   start with providing scientific context, refer to article
-   shift towards problem, introduce research questions
-   Context and previous research
-   Why is this important? Goal
-   Overview of the rest of the paper. Can do after
-   give detailed description of data (see rubric), which predictors are uncontrollable, controllable, indicators
-   start EDA, show some simple, interpretable plots regarding different predictors, find different relationships among controllable variables

### Modeling

-   Start with linear regression
-   check out interaction effects
-   ridge, lasso (for interpretable variable selection)
-   trees
-   stay away from uninterpretable methods like random forests, boosting

### Within Research Questions

-   focus on answering research question, using data/modeling merely as support for argument
-   make sure models and its results would be interpretable for global health professionals and governments
-   plot model diagnostics to assess models, make tables of results/predictions of models
-   give suggestions based on results to policy makers (ex. "this nation should put a greater prorportion of their total expenditure into health care to increase life expectancy")

### 

## Conclusion

In this study, we investigated the relationship between life expectancy and numerous factors using interpretable statistical models. For countries that are still developing, schooling has the strongest positive relationship with having life expectancy, and we suggest to countries that are developing to fund and prioritize education. The regression models and tree model both provide the necessary evidence to support this conclusion.\*\*\* Question 2.

### Conclusion

-   suggest in which factors specific nations should invest their money in based on modeling during both research questions, or, suggest not to increase investment in health care for nations with already high life expectancy
-   reference models, focus on interpretability and policy actions

## Appendix

### Data Dictionary

### Controllable Variables

-   `Alcohol`: Alcohol consumption per capita (liters of pure alcohol)
-   `pct_expend`: Expenditure on health as a percentage of GDP per capita
-   `hep_b`: Hepatitis B immunization rate among 1-year-olds (%)
-   `Polio`: Polio immunization rate among 1-year-olds (%)
-   `tot_expend`: Government expenditure on healthcare as a percentage of total government expenditure
-   `Diphtheria`: Diphtheria tetnus toxoid and pertussis immunization rate among 1-year-olds (%)
-   `Schooling`: Average number of years of schooling

### Uncontrollable Variables (Nuiscance Variables)

-   `BMI`: Average BMI (Body Mass Index) of entire country's population
-   `GDP`: GDP per capita
-   `Population`: Total population of country
-   `thinnes_adole`: Prevalence of "thinness" among adolescents aged 10-19 (%)
-   `thinness_infant`: Prevalence of "thinness" among infants aged 5-9 (%)
-   `income_comp`: Human Development Index in terms of income composition of resources (0 to 1)
-   `Status`: Developmental status of country (Developed or Developing)

### Indicator Variables

-   `under_five_deaths`: Number of deaths of 5-year-olds or younger per 1000 people
-   `life_exp`: Average expectancy in country (years)
-   `adult_mortality`: Number of deaths of people aged 15-60 per 1000 people
-   `infant_mortality`: Number of infants deaths per 1000 infants
-   `hiv_aids`: Number of deaths of 0-4 year-olds from HIV/AIDS per 1000 live births
